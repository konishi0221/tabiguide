<?php
require_once __DIR__ . '/../../core/dashboard_head.php';
require_once __DIR__ . '/../../core/create_from_images.php';
require_once __DIR__ . '/../../core/image_helper.php'; // ğŸ‘ˆ æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
require_once __DIR__ . '/../../core/facility_template.php' ; // â† PHPã‹ã‚‰èª­ã¿è¾¼ã‚€


$page_uid = $_POST['page_uid'] ?? null;
// if ($_SERVER['REQUEST_METHOD'] !== 'POST') die('POSTãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„');
// if (!$page_uid) die('page_uidãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
// if (!isset($_POST['facility_type']) || empty($_FILES['images'])) die('æ–½è¨­ã‚¿ã‚¤ãƒ—ã¾ãŸã¯ç”»åƒãŒæœªæŒ‡å®šã§ã™');

$facility_type = $_POST['facility_type'];
$files = $_FILES['images'];


$template = loadFacilityTemplate($facility_type);
// var_dump()

echo '<pre>' . htmlspecialchars(json_encode($template, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT), ENT_QUOTES, 'UTF-8') . '</pre>';
exit;


// ğŸ–¼ï¸ ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ç”»åƒã‚’ä½œæˆ
$encodedImages = resize_and_encode_images($files);

// // ğŸ“¦ ãƒ†ãƒ³ãƒ—ãƒ¬ã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿
// $templatePath = __DIR__ . '/../../core/facility_template.json';
// $template = json_decode(file_get_contents($templatePath), true);
// $template['æ–½è¨­ã‚¿ã‚¤ãƒ—'] = $facility_type;

$noteFields = ['base_notes', 'amenities_notes', 'rule_notes', 'location_notes', 'appeal_notes', 'others_notes'];
foreach ($noteFields as $field) {
    $template[$field] = '';
}
$template['rooms'] = [];

$templateJson = json_encode($template, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);



$noteFields = ['base_notes', 'amenities_notes', 'rule_notes', 'location_notes', 'appeal_notes', 'others_notes'];
foreach ($noteFields as $field) {
    $template[$field] = '';
}
$template['rooms'] = [];

$templateJson = json_encode($template, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
$prompt = <<<EOT
ã‚ãªãŸã¯é«˜ç²¾åº¦ã®æ§‹é€ åŒ–AIã§ã™ã€‚
ä»¥ä¸‹ã®ç”»åƒç¾¤ã«ã¯ã€å®¿æ³Šæ–½è¨­ã®æƒ…å ±ãŒè¦–è¦šçš„ãƒ»æ–‡ç« çš„ã«å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

---

### ã€ç›®çš„ã€‘

ã“ã®å®¿æ³Šæ–½è¨­ã«é–¢ã™ã‚‹ **ã™ã¹ã¦ã®æƒ…å ±**ï¼ˆåŸºæœ¬æƒ…å ±ã€è¨­å‚™ã€ãƒ«ãƒ¼ãƒ«ã€ã‚µãƒ¼ãƒ“ã‚¹ã€ç«‹åœ°ã€é­…åŠ›ãªã©ï¼‰ã‚’ç”»åƒã‹ã‚‰æŠ½å‡ºã—ã€
ä»¥ä¸‹ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ²¿ã£ã¦ **JSONå½¢å¼ã§æ§‹é€ åŒ–**ã—ã¦ãã ã•ã„ã€‚

â— **æ³¨æ„**ï¼š
ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€Œéƒ¨å±‹æ§‹æˆã€ã®æƒ…å ±ï¼ˆä¾‹ï¼šå’Œå®¤ã®æ•°ã€æ´‹å®¤ã®æ•°ã€ãƒªãƒ“ãƒ³ã‚°ã‚„ãƒ€ã‚¤ãƒ‹ãƒ³ã‚°ã®æœ‰ç„¡ãªã©ï¼‰ã¯æ§‹é€ åŒ–ã—ã¦ãã ã•ã„ã€‚
ãŸã ã—ã€å€‹åˆ¥ã®éƒ¨å±‹ã®è©³ç´°ï¼ˆéƒ¨å±‹åãƒ»ãƒ™ãƒƒãƒ‰æ§‹æˆãƒ»ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ãªã©ï¼‰ã¯å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„ã€‚
ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã« `rooms: []` ãŒå­˜åœ¨ã—ã¦ã„ã¦ã‚‚ã€ãã®å†…å®¹ã¯ç©ºé…åˆ—ã®ã¾ã¾ã§æ§‹ã„ã¾ã›ã‚“ã€‚
éƒ¨å±‹æƒ…å ±ã®æ§‹é€ åŒ–ã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿæ–½ã•ã‚Œã¾ã™ã€‚
åŸºæœ¬æƒ…å ±ã®æ–½è¨­ã‚¿ã‚¤ãƒ—ã¯çµ¶å¯¾ã«å¤‰æ›´ã—ãªã„ã§ãã ã•ã„ã€‚

---

### ã€å‡ºåŠ›å½¢å¼ã®ãƒ«ãƒ¼ãƒ«ã€‘

- å‡ºåŠ›ã¯ JSON å½¢å¼ã¨ã—ã¾ã™ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æº–æ‹ ï¼‰
- booleanå‹ã®é …ç›®ã¯ `{ "value": true/false, "note": "è£œè¶³" }` å½¢å¼ã§è¨˜è¿°ã—ã¦ãã ã•ã„
  - `note` ã¯ãªã‚‹ã¹ãç©ºæ¬„ã«ã›ãšã€åˆ¤æ–­ã®æ ¹æ‹ ãƒ»å‚™è€ƒã‚’ç°¡æ½”ã«è¨˜è¼‰ã—ã¦ãã ã•ã„
  - åˆ¤æ–­ã§ããªã„å ´åˆã¯ `"value": false` ã¨ã—ã€ `"note": "æƒ…å ±ãŒç”»åƒã«è¦‹å½“ãŸã‚‰ãªã‹ã£ãŸãŸã‚"` ãªã©ã®ç†ç”±ã‚’æ˜è¨˜ã—ã¦ãã ã•ã„
- æ§‹é€ åŒ–ã§ããªã„ãŒé‡è¦ãªæƒ…å ±ãŒã‚ã‚‹å ´åˆã¯ã€è©²å½“ã™ã‚‹ `*_notes` ã«æ—¥æœ¬èªã®ç®‡æ¡æ›¸ãï¼ˆ"ãƒ»"ï¼‰å½¢å¼ã§è¨˜è¿°ã—ã¦ãã ã•ã„ï¼ˆ1è¡Œ1é …ç›®ï¼‰
- `_notes` ã¯è£…é£¾çš„ãªæ–‡ç« ã§ã¯ãªãã€**å®Ÿç”¨çš„ã‹ã¤å…·ä½“çš„ãªè£œè¶³æƒ…å ±**ã‚’ä¸å¯§ã«è¨˜è¿°ã—ã¦ãã ã•ã„
- æ‰€åœ¨åœ°ï¼ˆä½æ‰€ï¼‰ãŒç¢ºèªã§ãã‚‹å ´åˆã€ç·¯åº¦ãƒ»çµŒåº¦ãŒå–å¾—å¯èƒ½ã‹ã‚’åˆ¤æ–­ã—ã€å¯èƒ½ã§ã‚ã‚Œã° `"ç·¯åº¦": "...", "çµŒåº¦": "..."` ã‚’å«ã‚ã¦ãã ã•ã„
- `"æ–½è¨­ã‚¿ã‚¤ãƒ—"` ã¯å¿…ãšæ–‡å­—åˆ—ï¼ˆä¾‹ï¼š`"æ—…é¤¨"` ã‚„ `"ãƒ›ãƒ†ãƒ«"` ãªã©ï¼‰ã¨ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆé…åˆ—ä¸å¯ï¼‰

---

### ã€éƒ¨å±‹æƒ…å ±ï¼ˆroomsï¼‰ã€‘

ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯éƒ¨å±‹æƒ…å ±ã‚’æ§‹é€ åŒ–ã—ãªã„ã§ãã ã•ã„ã€‚
ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã« `rooms: []` ãŒå«ã¾ã‚Œã¦ã„ã¦ã‚‚ã€ãã®ã¾ã¾ç©ºé…åˆ—ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
éƒ¨å±‹æƒ…å ±ã¯å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§å‡¦ç†ã•ã‚Œã¾ã™ã€‚

---

### ã€å„ *_notes ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å®šç¾©ã€‘

- `base_notes`ï¼šæ–½è¨­ã®æ§‹é€ ã‚„åŸºæœ¬ä»•æ§˜ã«é–¢ã™ã‚‹è£œè¶³ï¼ˆä¾‹ï¼šå¤æ°‘å®¶ãƒªãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã€éšæ®µã‚ã‚Šã€ä¸€æ£Ÿè²¸ã—ç­‰ï¼‰
- `amenities_notes`ï¼šå…¨ä½“è¨­å‚™ã‚„å‚™å“ãƒ»ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ã«é–¢ã™ã‚‹è£œè¶³ï¼ˆä¾‹ï¼šæªœé¢¨å‘‚ã€å’Œå®¤ã«åº§å“ã‚ã‚Šã€å†·è”µåº«å®Œå‚™ç­‰ï¼‰
- `rule_notes`ï¼šå®¿æ³Šãƒ«ãƒ¼ãƒ«ã‚„åˆ¶é™ãƒ»æ³¨æ„äº‹é …ãªã©ã®è£œè¶³ï¼ˆä¾‹ï¼šå–«ç…™é•åã¯ç½°é‡‘ã‚ã‚Šã€ãƒšãƒƒãƒˆç¦æ­¢ã€å¤œé–“é™ç²›ç­‰ï¼‰
- `location_notes`ï¼šç«‹åœ°ã‚„å‘¨è¾ºç’°å¢ƒã«é–¢ã™ã‚‹è£œè¶³ï¼ˆä¾‹ï¼šé–‘é™ãªä½å®…è¡—ã€é£²é£Ÿåº—å¯†é›†ã‚¨ãƒªã‚¢ã€é§…å¾’æ­©5åˆ†ç­‰ï¼‰
- `appeal_notes`ï¼šæ–½è¨­ã®é­…åŠ›ã‚„ç‹¬è‡ªæ€§ãƒ»é›°å›²æ°—ãªã©ï¼ˆä¾‹ï¼šæ—¥æœ¬åº­åœ’ã€ã‚¢ãƒ¼ãƒˆè£…é£¾ã€ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã‚ºå»ºç¯‰ç­‰ï¼‰
- `others_notes`ï¼šä¸Šè¨˜ã«åˆ†é¡ã§ããªã„ãŒé‡è¦ãªè£œè¶³ï¼ˆä¾‹ï¼š6æ­³ä»¥ä¸‹ç„¡æ–™ã€ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆå¾Œè·ç‰©é ã‹ã‚Šå¯ç­‰ï¼‰

---

### ã€é…åˆ—ã®ä¸­ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å«ã‚€é …ç›®ã«ã¤ã„ã¦ã€‘

- ä¸€éƒ¨ã®é …ç›®ï¼ˆä¾‹ï¼š"ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£", "ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°", "è²¸å‡ºå‚™å“" ãªã©ï¼‰ã¯ã€é…åˆ—ã®ä¸­ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã§æƒ…å ±ã‚’ä¸¦ã¹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
- ãã®ã‚ˆã†ãªé …ç›®ã§ã¯ã€å„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« `"title"`, `"content"`, `"price"` ã®ã‚ˆã†ãªã‚­ãƒ¼ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
- å†…å®¹ãŒå˜ç´”ãªãƒªã‚¹ãƒˆã§ã¯ãªãã€ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜ãƒ»é‡‘é¡ãªã©ã‚’ä¼´ã†æƒ…å ±ã§ã‚ã‚‹ã¨åˆ¤æ–­ã•ã‚Œã‚‹å ´åˆã¯ã€
  ãã‚Œãã‚Œã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦é…åˆ—ã«è¿½åŠ ã—ã€ä¸¦åˆ—ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
- æƒ…å ±ãŒ1ä»¶ã—ã‹ãªã„å ´åˆã§ã‚‚ã€é…åˆ—å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚


### ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€‘

{$templateJson}
EOT;

// ğŸ” AIæ§‹é€ åŒ–JSONã‚’å–å¾—
$json = create_from_images($encodedImages, $facility_type, $template, $prompt);

// ğŸ“ ä»¥é™ã®å‡¦ç†ã¯ãã®ã¾ã¾ï¼ˆ$data ã«ã—ã¦ DBã¸ä¿å­˜å‡¦ç†ï¼‰...

?>




<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ–½è¨­æƒ…å ±ã®ç¢ºèª</title>
  <style>
    body {
      font-family: monospace;
      background: #f9f9f9;
      padding: 2rem;
    }
    pre {
      background: #fff;
      border: 1px solid #ccc;
      padding: 1rem;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    h1 {
      font-size: 1.5em;
      margin-bottom: 1rem;
    }
    .button {
      display: inline-block;
      background: #007acc;
      color: #fff;
      padding: 0.6em 1.2em;
      border-radius: 4px;
      text-decoration: none;
      margin-top: 1em;
    }
  </style>
</head>
<body>
  <h1>æ§‹é€ åŒ–ã•ã‚ŒãŸæ–½è¨­æƒ…å ±ã®ç¢ºèª</h1>
  <pre><?= htmlspecialchars($json, ENT_QUOTES, 'UTF-8') ?></pre>
  <a class="button" href="index.php?page_uid=<?= htmlspecialchars($page_uid) ?>">æˆ»ã‚‹</a>
</body>
</html>
